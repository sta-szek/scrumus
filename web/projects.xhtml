<h:body xmlns="http://www.w3.org/1999/xhtml"
        xmlns:h="http://xmlns.jcp.org/jsf/html"
        xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
        xmlns:f="http://xmlns.jcp.org/jsf/core"
        xmlns:p="http://primefaces.org/ui"
        xmlns:c="http://xmlns.jcp.org/jsp/jstl/core">
    <ui:composition template="#{path['common.template']}">
        <ui:define name="content">
            <f:metadata>
                <f:viewParam name="projectKey" />
            </f:metadata>

            <c:if test="${not empty projectKey}">
                <c:if test="#{not permissionService.hasRightsForProject(request.remoteUser,projectKey)}">
                    #{facesContext.getCurrentInstance().externalContext.redirect(request.contextPath.concat(path['accessDenied']))}
                </c:if>
                <ui:param name="project" value="#{projectService.findByProjectKey(projectKey)}" />
            </c:if>

            <p:accordionPanel multiple="true" rendered="#{empty projectKey}">
                <c:forEach items="#{projectService.getUserProjects(request.remoteUser)}" var="project">
                    <p:tab title="#{project.name}">
                        <h2>
                            <h:outputLink value="#{request.contextPath}#{path['project']}?projectKey=#{project.key}">
                                <h:outputText value="#{project.name}" />
                            </h:outputLink>
                        </h2>
                        <h:outputText value="#{project.description}" />
                    </p:tab>
                </c:forEach>
            </p:accordionPanel>

            <p:outputLabel value="#{i18n['page.project.notFound']}"
                           rendered="#{empty project and not empty projectKey}" />

            <p:messages />
            <p:outputPanel id="projectDetails" rendered="#{not empty project}">

                <!-- INFORMACJE O PROJEKCIE -->
                <p:accordionPanel id="mainAccordionPannel" multiple="true">

                    <!-- glowne informacje -->
                    <p:tab id="projectDetailsTab" title="#{project.name}">
                        <div class="ui-grid ui-grid-responsive">
                            <h2>
                                <h:outputText value="#{project.name}" styleClass="ui-grid-row ui-grid-col-12" />
                            </h2>

                            <div class="ui-grid-row ui-grid-col-12">
                                <h:outputLink value="#{request.contextPath}#{path['agileBoard']}?projectKey=#{project.key}"
                                              styleClass="ui-grid-col-6">
                                    <h:outputText value="#{i18n['page.project.agile']}" />
                                </h:outputLink>
                            </div>

                            <div class="ui-grid-row">
                                <p:outputLabel for="key"
                                               value="#{i18n['page.project.label.key']}"
                                               styleClass="ui-grid-row ui-grid-col-1" />
                                <h:outputText id="key" value="#{project.key}" styleClass="ui-grid-row ui-grid-col-11" />
                            </div>

                            <div class="ui-grid-row">
                                <p:outputLabel for="startDate" value="#{i18n['page.project.label.start']}" styleClass="ui-grid-col-1" />
                                <h:outputText id="startDate" value="#{project.creationDate}" styleClass="ui-grid-col-11" />
                            </div>
                            <div class="ui-grid-row">
                                <p:outputLabel for="definitionOfDone"
                                               value="#{i18n['page.project.label.definitionOfDone']}"
                                               styleClass="ui-grid-row ui-grid-col-1" />
                                <h:outputText id="definitionOfDone" value="#{project.definitionOfDone}" styleClass="ui-grid-col-11" />
                            </div>
                            <div class="ui-grid-row">
                                <p:outputLabel for="description"
                                               value="#{i18n['page.project.label.description']}"
                                               styleClass="ui-grid-row ui-grid-col-1" />
                                <h:outputText id="description" value="#{project.description}" styleClass="ui-grid-col-11" />
                            </div>
                        </div>
                    </p:tab>

                    <!-- zakladka backlogu -->
                    <c:set var="backlog" value="#{agileService.backlogForCurrentlyViewedProject}" />
                    <p:tab id="projectBacklogTab" rendered="${not empty backlog}" title="#{i18n['page.project.backlog.header']}">

                        <div class="ui-grid ui-grid-responsive ui-grid-row issue-list-header">

                            <p:outputLabel value="#{i18n['page.project.backlog.issue.summary']}" styleClass="ui-grid-col-3" />

                            <p:outputLabel value="#{i18n['page.project.backlog.issue.description']}" styleClass="ui-grid-col-4" />

                            <p:outputLabel value="#{i18n['page.project.backlog.issue.reporter']}" styleClass="ui-grid-col-1" />

                            <p:outputLabel value="#{i18n['page.project.backlog.issue.assignee']}" styleClass="ui-grid-col-1" />

                            <p:outputLabel value="#{i18n['page.project.backlog.issue.actions']}" styleClass="ui-grid-col-3" />
                        </div>

                        <!-- lista zadan w backlogu -->
                        <c:forEach var="issue" items="#{backlog.issues}">
                            <div class="ui-grid ui-grid-responsive ui-grid-row issue-list-item">

                                <p:outputLabel value="#{issue.summary} &#160;" styleClass="ui-grid-col-3" />

                                <p:outputLabel value="#{issue.description} &#160;" styleClass="ui-grid-col-4" />

                                <p:outputLabel value="#{userService.findUser(issue.reporterId).fullName} &#160;"
                                               styleClass="ui-grid-col-1" />

                                <p:outputLabel value="#{userService.findUser(issue.assigneeId).fullName} &#160;"
                                               styleClass="ui-grid-col-1" />

                                <div class="ui-grid-col-3">
                                    <p:button outcome="issue"
                                              value="#{i18n['page.project.backlog.issue.link']}">
                                        <f:param name="issueId" value="#{issue.id}" />
                                    </p:button>
                                    <p:commandButton id="moveIssueToStoryButton"
                                                     value="#{i18n['page.project.backlog.move.story']}"
                                                     onclick="PF('moveToStory').show()"
                                                     action="#{agileService.setMoveIssue(issue)}" immediate="true">
                                        <f:param name="test1" value="#{issue}" />
                                        <f:passThroughAttribute name="test2" value="#{issue}" />
                                        <f:viewParam name="test2" value="#{issue}" />
                                        <f:setPropertyActionListener value="#{issue}" target="#{testService.issueToMove}" />
                                        <ui:param name="test3" value="#{issue}" />
                                    </p:commandButton>
                                </div>
                            </div>
                        </c:forEach>

                    </p:tab>

                    <!-- zakladka sprintow -->
                    <c:set var="sprints" value="#{agileService.sprintsForCurrentlyViewedProject}" />
                    <p:tab id="projectSprintTab" rendered="${not empty sprints}" title="#{i18n['page.project.sprints.header']}">
                        <div class="ui-grid ui-grid-responsive">
                            <!-- naglowek sprintow -->
                            <div class="ui-grid-row issue-list-header">

                                <p:outputLabel value="#{i18n['page.project.sprint.name']}" styleClass="ui-grid-col-6" />

                                <p:outputLabel value="#{i18n['page.project.sprint.time.start']}" styleClass="ui-grid-col-2" />

                                <p:outputLabel value="#{i18n['page.project.sprint.time.end']}" styleClass="ui-grid-col-2" />

                                <p:outputLabel value="#{i18n['page.project.sprint.actions']}" styleClass="ui-grid-col-2" />
                            </div>

                            <!--lista sprintÃ³w-->
                            <c:forEach var="sprint" items="#{sprints}">
                                <div class="ui-grid-row issue-list-item">

                                    <p:outputLabel value="#{sprint.name} &#160;" styleClass="ui-grid-col-6" />

                                    <p:outputLabel value="#{sprint.timeRange.startDate} &#160;" styleClass="ui-grid-col-2" />

                                    <p:outputLabel value="#{sprint.timeRange.endDate} &#160;" styleClass="ui-grid-col-2" />

                                    <div class="ui-grid-col-2">
                                        <p:button outcome="#{path['retrospective']}"
                                                  value="#{i18n['page.project.sprint.retrospective.link']}"
                                                  rendered="${not empty sprint.retrospectiveId}">
                                            <f:param name="retrospectiveId" value="#{sprint.retrospectiveId}" /></p:button>
                                    </div>
                                </div>

                                <!--zakÅadka story -->
                                <p:spacer />
                                <p:fieldset id="storySprintTab"
                                            legend="#{i18n['page.project.sprint.stories.list']}"
                                            toggleable="true"
                                            collapsed="true"
                                            styleClass="ui-grid-row ui-grid-col-12"
                                            style="padding-bottom: 10px !important;">
                                    <!-- lista story -->
                                    <c:forEach var="story" items="#{agileService.getStoriesForSprint(sprint.id)}">
                                        <p:fieldset legend="#{story.name} (#{story.points})"
                                                    toggleable="true"
                                                    collapsed="true"
                                                    styleClass="ui-grid-row ui-grid-col-12">
                                            <div class="ui-grid ui-grid-responsive ui-grid-row issue-list-header">

                                                <p:outputLabel value="#{i18n['page.project.story.issue.summary']}"
                                                               styleClass="ui-grid-col-3" />

                                                <p:outputLabel value="#{i18n['page.project.story.issue.description']}"
                                                               styleClass="ui-grid-col-4" />

                                                <p:outputLabel value="#{i18n['page.project.story.issue.reporter']}"
                                                               styleClass="ui-grid-col-1" />

                                                <p:outputLabel value="#{i18n['page.project.story.issue.assignee']}"
                                                               styleClass="ui-grid-col-1" />

                                                <p:outputLabel value="#{i18n['page.project.story.issue.actions']}"
                                                               styleClass="ui-grid-col-3" />
                                            </div>

                                            <!--lista zadan w story-->
                                            <c:forEach var="issue" items="#{story.issues}">
                                                <div class="ui-grid ui-grid-responsive ui-grid-row issue-list-item">

                                                    <p:outputLabel value="#{issue.summary} &#160;" styleClass="ui-grid-col-3" />

                                                    <p:outputLabel value="#{issue.description} &#160;" styleClass="ui-grid-col-4" />

                                                    <p:outputLabel value="#{userService.findUser(issue.reporterId).fullName} &#160;"
                                                                   styleClass="ui-grid-col-1" />

                                                    <p:outputLabel value="#{userService.findUser(issue.assigneeId).fullName} &#160;"
                                                                   styleClass="ui-grid-col-1" />

                                                    <div class="ui-grid-col-3">

                                                        <p:button outcome="issue"
                                                                  value="#{i18n['page.project.story.issue.link']}">
                                                            <f:param name="issueId" value="#{issue.id}" />
                                                        </p:button>
                                                        <p:commandButton action="#{agileService.moveToBacklog(issue, story)}"
                                                                         value="#{i18n['page.project.story.move.backlog']}">
                                                            <f:setPropertyActionListener value="#{issue}"
                                                                                         target="#{agileService.issue}" />
                                                        </p:commandButton>


                                                    </div>

                                                </div>
                                            </c:forEach>

                                        </p:fieldset>
                                    </c:forEach>
                                </p:fieldset>
                            </c:forEach>
                        </div>
                    </p:tab>

                </p:accordionPanel>
            </p:outputPanel>

            <p:dialog showEffect="fade"
                      hideEffect="fade"
                      widgetVar="moveToStory"
                      header="#{i18n['page.project.backlog.move.story.header']}"
                      icon="fa fa-warning">
                #{test1}
                #{test2}
                #{test3}
                <h:form id="moveToStoryForm">
                    <p:autoComplete id="sprint"
                                    multiple="false"
                                    value="#{agileService.moveIssueToSprint}"
                                    completeMethod="#{agileService.completeSprints}"
                                    var="sprint"
                                    itemLabel="#{sprint}"
                                    itemValue="#{sprint}"
                                    forceSelection="true"
                                    dropdown="true">
                        <p:ajax event="itemSelect" listener="#{agileService.onItemSelect}" update="story" />
                        <p:column>
                            <h:outputText value="#{sprint}" />
                        </p:column>
                    </p:autoComplete>
                    <br />
                    <p:autoComplete id="story"
                                    multiple="false"
                                    value="#{agileService.moveIssueToStory}"
                                    completeMethod="#{agileService.completeSprintStories}"
                                    var="story"
                                    itemLabel="#{story}"
                                    itemValue="#{story}"
                                    forceSelection="true"
                                    dropdown="true">
                        <p:column>
                            <h:outputText value="#{story}" />
                        </p:column>
                    </p:autoComplete>
                    <br />
                    <p:commandButton value="#{i18n['page.project.backlog.move.story.yes']}"
                                     styleClass="ui-confirmdialog-yes"
                                     icon="ui-icon-check"
                                     action="#{agileService.moveIssueToStory()}"
                                     oncomplete="PF('moveToStory').hide()"
                                     update="mainAccordionPannel">
                        <f:ajax render="mainAccordionPannel" />
                    </p:commandButton>
                    <p:commandButton value="#{i18n['page.project.backlog.move.story.cancel']}"
                                     styleClass="ui-confirmdialog-no"
                                     icon="ui-icon-close"
                                     onclick="PF('moveToStory').hide()" />
                </h:form>
            </p:dialog>
        </ui:define>
    </ui:composition>
</h:body>

